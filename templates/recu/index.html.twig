{% extends 'empty.html.twig' %}

{% block body %}
<style>
    body {
        font-family: DejaVu Sans, Arial, sans-serif;
        font-size: 12px;
        color: #333;
        margin: 20px;
    }

    h1 {
        font-size: 22px;
        margin-bottom: 10px;
    }

    .invoice-header {
        margin-bottom: 20px;
    }

    .seller-client {
        width: 100%;
        border: 1px solid #000;
        border-collapse: collapse;
        padding: 10px;
        margin-bottom: 25px;
    }

    .seller-client td {
        width: 50%;
        vertical-align: top;
        padding: 5px;
    }

    .product-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 12px;
    }

    .product-table th {
        background-color: #f2f2f2;
        border: 1px solid #000;
        text-align: center;
        padding: 6px;
        font-weight: bold;
    }

    .product-table td {
        border: 1px solid #000;
        padding: 6px;
    }

    .product-table tr:nth-child(even) {
        background-color: #fafafa;
    }

    .text-right {
        text-align: right;
    }

    .totals {
        margin-top: 25px;
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

    .totals td, .totals th {
        border: 1px solid #000;
        padding: 6px;
    }

    .totals th {
        background-color: #f2f2f2;
        text-align: right;
    }

    .legal {
        font-size: 11px;
        margin-top: 20px;
        line-height: 1.4;
    }
</style>

<div class="invoice-header">
    <h1>Reçu n° {{ sale.id }}</h1>
    <p><strong>Date d’émission :</strong> {{ sale.createdAt|date('d/m/Y') }}</p>
</div>

<table class="seller-client">
    <tr>
        <td>
            <strong>{{ sellerName }}</strong><br>
            {{ sellerAddress }}<br>
            {{ sellerPostalCode }} {{ sellerCity }}<br>
            {% if sellerSiret %}SIRET : {{ sellerSiret }}<br>{% endif %}
            {% if sellerVatNumber %}TVA intracom : {{ sellerVatNumber }}<br>{% endif %}
        </td>
        <td style="text-align:right;">
            <strong>{{ sale.clientName }}</strong><br>
        </td>
    </tr>
</table>

<table class="product-table">
    <tr>
        <th style="width: 40%;">Désignation</th>
        <th style="width: 15%;">Quantité</th>
        <th style="width: 15%;">PU HT</th>
        <th style="width: 10%;">TVA</th>
        <th style="width: 20%;">Total TTC</th>
    </tr>
    {% if sale.saleProducts is not empty %}
        {% for saleProduct in sale.saleProducts %}
            {% set total_ttc = saleProduct.quantity * saleProduct.price %}

            {# Total HT for the product #}
            {% set total_ht = total_ttc / (1 + saleProduct.product.tvaNumber / 100) %}

            {# Unit price HT #}
            {% set pu_ht = total_ht / saleProduct.quantity %}

            <tr>
                <td>{{ saleProduct.product.name }}</td>
                <td class="text-right">{{ saleProduct.quantity|number_format(2, ',', ' ') }}</td>
                <td class="text-right">{{ pu_ht|number_format(2, ',', ' ') }} €</td>
                <td class="text-right">{{ saleProduct.product.tvaNumber }} %</td>
                <td class="text-right">{{ (saleProduct.quantity * saleProduct.price)|number_format(2, ',', ' ') }} €</td>

            </tr>
        {% endfor %}
    {% else %}
        <tr>
            <td colspan="5" style="text-align:center; font-style:italic;">Aucun produit enregistré</td>
        </tr>
    {% endif %}
</table>

<table class="totals">
    {# calculate ht && ttc accu #}
    {% set total_ht_global = 0 %}
    {% set total_ttc_global = 0 %}

    {% for saleProduct in sale.saleProducts %}
        {# Total TTC for this product #}
        {% set total_ttc = saleProduct.quantity * saleProduct.price %}

        {# Total HT for this product #}
        {% set total_ht = total_ttc / (1 + saleProduct.product.tvaNumber / 100) %}

        {# Accumulate total HT #}
        {% set total_ht_global = total_ht_global + total_ht %}
    {% endfor %}

    {% for saleProduct in sale.saleProducts %}
        {# Total TTC for this product #}
        {% set total_ttc_global = total_ttc_global + saleProduct.quantity * saleProduct.price %}
    {% endfor %}

    <tr>
        <td style="text-align:right;"><strong>Total HT</strong></td>
        <td class="text-right"><strong>{{ total_ht_global|number_format(2, ',', ' ') }} €</strong</td>
    </tr>
    <tr>
        <th style="text-align:right;">Total TVA</th>
        <th class="text-right">{{(total_ttc_global - total_ht_global)|number_format(2, ',', ' ') }} €</th>
    </tr>
    <tr>
        <th style="text-align:right;">Total TTC</th>
        <th class="text-right">{{total_ttc_global|number_format(2, ',', ' ') }} €</th>
    </tr>
</table>

<p style="margin-top:10px;">
    Règlement par : <strong>{{translatedPaymentType}}</strong> 
</p>

{% endblock %}