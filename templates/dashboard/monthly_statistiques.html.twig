{% extends 'base.html.twig' %}

{% block body %}
<div class="page-header d-print-none">
  <div class="container-xl d-flex justify-content-between align-items-center">
    <h1 class="page-title mb-3">Statistiques du mois {{ month }}/{{ year }}</h1>
    <a 
    href="{{ path('app_monthly_export', { month: month }) }}" 
    class="btn d-flex text-white "
    style="background-color: #217346;"
    data-controller="button-icon"
    >
        {{ ux_icon('uiw:file-excel', { style: 'width:24px; height:24px;' }) }}
        <span class="mx-2">Exporter Excel</span>
    </a>
  </div>
</div>


<div class="container-xl py-4">
  <!-- Month selection card -->
  <div class="card mb-4 w-100 shadow-sm">
    <div class="card-body">
      <form method="get" class="d-flex align-items-center justify-content-between gap-3">
        <div>
          <h3 class="card-title mb-0">Sélectionner un mois</h3>
          <p class="text-muted">Choisissez un mois pour afficher les statistiques correspondantes.</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <select name="month" class="form-control form-select">
            {% for key, label in months %}
              <option value="{{ key }}" {% if key == month %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-primary">
            <i class="ti ti-search me-1"></i> Rechercher
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main stats cards -->
  <div class="row row-cards mb-4">
    <div class="col-sm-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="text-uppercase text-muted font-weight-medium">Total des ventes</div>
          <div class="display-6 fw-bold text-red">{{ totalRevenue|number_format(2, ',', ' ') }} €</div>
        </div>
      </div>
    </div>

    <div class="col-sm-6 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body text-center">
          <div class="text-uppercase text-muted font-weight-medium">Nombre de clients</div>
          <div class="display-6 fw-bold text-primary">{{ clientCount }}</div>
        </div>
      </div>
    </div>


    <div class="col-sm-6 col-lg-4">
        <div class="card shadow-sm">
          <div class="card-body text-center">
            <div class="text-uppercase text-muted font-weight-medium">Nombre de produits vendues</div>
            <div class="display-6 fw-bold text-success">{{ totalProductSold }}</div>
          </div>
        </div>
    </div>
  </div>

  <!-- Category sales -->
  <h3 class="mb-3">Ventes par catégorie</h3>
  {% for category in categoryStats %}
    <div class="card shadow-sm mb-4 border-0">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <div>
          <h3 class="card-title mb-0 fw-semibold">{{ category.category }}</h3>
        </div>
        <div class="d-flex gap-5">
          <div class="text-center d-flex flex-column align-content-between justify-content-between">
            <div class="text-muted small text-uppercase mb-1">Quantité totale</div>
            <div class="fs-4 fw-bold text-success">{{ category.quantity }}</div>
          </div>
          <div class="text-center d-flex flex-column align-content-between justify-content-between">
            <div class="text-muted small text-uppercase mb-1">Chiffre d'affaires</div>
            <div class="fw-bold text-primary fs-4">{{ category.revenue|number_format(2, ',', ' ') }} €</div>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center text-muted">
        Aucune vente enregistrée pour ce mois.
      </div>
    </div>
  {% endfor %}

  <!-- Daily trend chart -->
  <h3 class="mb-3">Évolution quotidienne des ventes</h3>
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <canvas id="monthlyTrendChart"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('monthlyTrendChart');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: {{ trendLabels|json_encode|raw }},
    datasets: [{
      label: 'Chiffre d\'affaires quotidien',
      data: {{ trendValues|json_encode|raw }},
      fill: false,
      borderColor: 'rgba(54, 162, 235, 1)',
      tension: 0.1
    }]
  },
  options: {
    responsive: true,
    plugins: {
      legend: { display: true },
      tooltip: { mode: 'index', intersect: false }
    },
    scales: {
      x: { title: { display: true, text: 'Jour du mois' } },
      y: { title: { display: true, text: 'Chiffre d\'affaires (€)' } }
    }
  }
});
</script>
{% endblock %}