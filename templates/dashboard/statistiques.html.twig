{% extends 'base.html.twig' %}

{% block content %}

<!-- JS -->
<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script src="/assets/js/chart-js-4.5.0.js"></script>

<div class="w-100 py-4">
    <h1 class="text-2xl font-bold mb-4">{{ 'Back-office Boulangerie ðŸ¥–'|trans }}</h1>

    <!-- Cards statistiques -->
    <div class="row mb-4 g-3">
        <div class="col-md-3">
            <div class="card ea-bg-card rounded-3 shadow-sm text-center p-3 h-100">
                <h5 class="card-title">{{ 'Total ventes'|trans }}</h5>
                <p class="fs-3">{{ totalSales }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card ea-bg-card rounded-3 shadow-sm text-center p-3 h-100">
                <h5 class="card-title">{{ 'Montant total'|trans }}</h5>
                <p class="fs-3">{{ totalAmount|number_format(2, ',', ' ') }} â‚¬</p>
            </div>
        </div>
    </div>

    <!-- SÃ©lection du mois -->
    <div class="mb-4">
        <label for="month" class="form-label fw-semibold me-2">{{ 'Mois'|trans }} :</label>
        <select id="month" class="form-select w-auto d-inline-block"
                onchange="window.location.href = this.options[this.selectedIndex].dataset.url;">
            {% for num, name in months %}
                {% set url = path('admin_statistiques', {'id': num, 'month': num}) %}
                <option value="{{ num }}"
                        data-url="{{ url }}"
                        {% if currentMonth == num %}selected{% endif %}>
                    {{ name|trans }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- Graphiques cÃ´te Ã  cÃ´te -->
    <div class="container">
        <div class="row justify-content-start mb-3">
            <div class="col-6">
                <h3 class="text-white">{{ 'Recettes par jour'|trans }} - {{ months[currentMonth]|trans }}</h3>
            </div>
            <div class="col-6">
                <h3 class="text-white">{{ 'Moyenne quotidienne'|trans }} - {{ months[currentMonth]|trans }}</h3>
            </div>
        </div>

        <div class="row justify-content-start">
            <!-- Bar chart Ã  gauche -->
            <div class="col-6" style="height: 500px;">
                <canvas id="barChart"></canvas>
            </div>

            <!-- Line chart Ã  droite -->
            <div class="col-6" style="height: 500px;">
                <canvas id="lineChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
// RÃ©cupÃ©ration et formatage des donnÃ©es
const dailyLabels = {{ dailyRevenueLabels|json_encode|raw }}.map(String); // force strings
const dailyValues = {{ dailyRevenueValues|json_encode|raw }}.map(Number); // force numbers

// Calcul de la moyenne quotidienne pour le line chart
const avg = dailyValues.reduce((a, b) => a + b, 0) / dailyValues.length;
const averageLine = Array(dailyValues.length).fill(avg);

// Bar Chart
const barCtx = document.getElementById('barChart').getContext('2d');
new Chart(barCtx, {
    type: 'bar',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: '{{ "Recette (â‚¬)"|trans }}',
            data: dailyValues,
            backgroundColor: 'rgba(0, 51, 102, 0.8)',
            borderColor: 'rgba(0, 51, 102, 1)',
            borderWidth: 1,
            hoverBackgroundColor: 'rgba(0, 51, 102, 1)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        },
        plugins: { legend: { labels: { color: 'white' } } }
    }
});

// Line Chart
const lineCtx = document.getElementById('lineChart').getContext('2d');
new Chart(lineCtx, {
    type: 'line',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: '{{ "Moyenne (â‚¬)"|trans }}',
            data: averageLine,
            borderColor: 'white',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointBackgroundColor: 'white'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
            y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
        },
        plugins: { legend: { labels: { color: 'white' } } }
    }
});
</script>

{% endblock %}